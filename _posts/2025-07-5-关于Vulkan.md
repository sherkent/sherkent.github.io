---
title: NHS Vulkan 兼容性误判复盘
date: 2025-08-23
categories: [Android, Vulkan, NHS]
tags: [N12T, SurfaceFlinger, 源码]
---

> 因撰写仓促，水平有限，本文多为“拿着答案推过程”，如有错误请海涵。  
> 特别感谢 **潘多拉内核开发组**。

## 背景
上月有 NHS 用户拿着酷安帖子称 **Marble（N12T）** 已可启用 Vulkan，实测却直接不开机——去年 12 月潘多拉就踩过同样坑。抱着“此一时彼一时”的心态，我决定再做一次可行性验证。

## 验证过程
1. **先找调用者**  
   若某 prop 无调用者，它就只是“虚空开关”。  
   示例：`dalvik.vm.ps-min-first-save-ms` 在 `AndroidRuntime.cpp:919` 直接硬编码，可搜到二进制；但模块里的大多数 prop 在源码/二进制中均无结果，可剔除。

2. **精简后机器顺利开机**  
   用 `dumpsys SurfaceFlinger | grep -i vulkan` 检查 → **无 Vulkan 输出**，说明模块无效，用户反馈纯属“安慰剂效应”。

3. **再次翻车的根源：未回归源码**  
   HamJTY 提醒后，逐条核对 prop：

| prop 名称 | 允许值 | 实际值 | 结果 |
|---|---|---|---|
| `debug.hwui.renderer` | `skiavk` / `skiagl` | `vulkanthreaded` | ❌ |
| `debug.stagefright.renderengine.backend` | `gles` / `threaded` | `vulkan` | ❌ |
| `debug.renderengine.backend` | `skiagl*` / `skiavk*` | `vulkan` | ❌ |
| `debug.rs.visual` | 非 0 即开调试 | `vulkan` | ❌（与 Vulkan 无关） |
| `debug.hwui.use_vulkan` | 需配合上一条 | `true` | ❌ |
| **缺失关键项** |  |  |  |
| `debug.renderengine.vulkan` | `true` 才可启用 Vulkan | 未设置 | ❌ |

- [Properties.h#L138](https://cs.android.com/android/platform/superproject/main/+/main:frameworks/base/libs/hwui/Properties.h;l=138)  
- [Properties.cpp#L246](https://cs.android.com/android/platform/superproject/main/+/main:frameworks/base/libs/hwui/Properties.cpp;l=246)  
- [SurfaceFlinger.cpp#L856](https://cs.android.com/android/platform/superproject/main/+/main:frameworks/native/services/surfaceflinger/SurfaceFlinger.cpp;l=856)  
- [FlagManager.cpp#L242](https://cs.android.com/android/platform/superproject/main/+/main:frameworks/native/services/surfaceflinger/common/FlagManager.cpp;l=242)

补上 `debug.renderengine.vulkan=true` 后，Vulkan 才真正生效。

## 教训
- **可行性验证必须回归源码**  
- **切忌盲信社区“成功案例”**  
- **留足时间做最小可复现集合（MVP）**

#红米Note12Turbo#